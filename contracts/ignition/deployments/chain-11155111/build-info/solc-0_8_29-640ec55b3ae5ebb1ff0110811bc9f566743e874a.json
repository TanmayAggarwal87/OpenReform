{
  "_format": "hh3-sol-build-info-1",
  "id": "solc-0_8_29-640ec55b3ae5ebb1ff0110811bc9f566743e874a",
  "solcVersion": "0.8.29",
  "solcLongVersion": "0.8.29+commit.ab55807c",
  "userSourceNameMap": {
    "contracts/EscrowMilestones.sol": "project/contracts/EscrowMilestones.sol"
  },
  "input": {
    "language": "Solidity",
    "settings": {
      "evmVersion": "cancun",
      "optimizer": {
        "enabled": true,
        "runs": 200
      },
      "outputSelection": {
        "*": {
          "": [
            "ast"
          ],
          "*": [
            "abi",
            "evm.bytecode",
            "evm.deployedBytecode",
            "evm.methodIdentifiers",
            "metadata"
          ]
        }
      },
      "remappings": []
    },
    "sources": {
      "project/contracts/EscrowMilestones.sol": {
        "content": "// SPDX-License-Identifier: MIT\r\npragma solidity ^0.8.29;\r\n\r\ninterface IPetitionRegistry {\r\n  function getPetition(uint256 petitionId)\r\n    external\r\n    view\r\n    returns (address creator, string memory contentCID, uint256 createdAt, uint256 supportCount);\r\n}\r\n\r\ninterface IImplementerRegistry {\r\n  function getProfile(address implementer) external view returns (string memory);\r\n}\r\n\r\ncontract EscrowMilestones {\r\n  event Funded(uint256 petitionId, address funder, uint256 amount, uint256 timestamp);\r\n  event ImplementerAccepted(uint256 petitionId, address implementer, string profileCID, uint256 timestamp);\r\n  event MilestoneSubmitted(uint256 petitionId, uint256 milestoneIndex, string proofCID, uint256 timestamp);\r\n  event MilestoneApproved(uint256 petitionId, uint256 milestoneIndex, address approver, uint256 timestamp);\r\n  event PayoutReleased(uint256 petitionId, uint256 milestoneIndex, uint256 amount, address implementer, uint256 timestamp);\r\n  event RefundsClaimed(uint256 petitionId, address claimant, uint256 amount, uint256 timestamp);\r\n\r\n  struct PetitionEscrow {\r\n    address creator;\r\n    address implementer;\r\n    uint256 deadline;\r\n    uint256 totalFunded;\r\n    uint256 totalPaid;\r\n    uint256 milestoneCount;\r\n    uint256 currentMilestone;\r\n    bool initialized;\r\n  }\r\n\r\n  struct Milestone {\r\n    uint256 amount;\r\n    bool approved;\r\n    bool paid;\r\n    string proofCID;\r\n    uint256 submittedAt;\r\n    uint256 submissionCount;\r\n  }\r\n\r\n  struct Vote {\r\n    uint256 yesVotes;\r\n    uint256 noVotes;\r\n    uint256 endTime;\r\n    bool finalized;\r\n  }\r\n\r\n  IPetitionRegistry public immutable petitionRegistry;\r\n  IImplementerRegistry public immutable implementerRegistry;\r\n  uint256 public immutable votingWindow;\r\n\r\n  mapping(uint256 => PetitionEscrow) private _escrows;\r\n  mapping(uint256 => Milestone[]) private _milestones;\r\n  mapping(uint256 => mapping(address => uint256)) private _fundedBy;\r\n  mapping(address => uint256) private _pendingPayouts;\r\n\r\n  mapping(uint256 => mapping(uint256 => Vote)) private _votes;\r\n  mapping(uint256 => mapping(uint256 => uint256)) private _voteRounds;\r\n  mapping(uint256 => mapping(uint256 => mapping(address => uint256))) private _lastVotedRound;\r\n\r\n  uint256 private _locked = 1;\r\n\r\n  constructor(address petitionRegistryAddress, address implementerRegistryAddress, uint256 votingWindowSeconds) {\r\n    require(petitionRegistryAddress != address(0), \"INVALID_REGISTRY\");\r\n    require(implementerRegistryAddress != address(0), \"INVALID_IMPLEMENTER_REGISTRY\");\r\n    require(votingWindowSeconds > 0, \"INVALID_WINDOW\");\r\n    petitionRegistry = IPetitionRegistry(petitionRegistryAddress);\r\n    implementerRegistry = IImplementerRegistry(implementerRegistryAddress);\r\n    votingWindow = votingWindowSeconds;\r\n  }\r\n\r\n  modifier nonReentrant() {\r\n    require(_locked == 1, \"REENTRANCY\");\r\n    _locked = 2;\r\n    _;\r\n    _locked = 1;\r\n  }\r\n\r\n  function configureMilestones(uint256 petitionId, uint256[] calldata amounts, uint256 deadline) external {\r\n    (address creator, , , ) = petitionRegistry.getPetition(petitionId);\r\n    require(creator != address(0), \"PETITION_NOT_FOUND\");\r\n    require(creator == msg.sender, \"NOT_CREATOR\");\r\n    require(amounts.length > 0, \"NO_MILESTONES\");\r\n    require(deadline > block.timestamp, \"INVALID_DEADLINE\");\r\n\r\n    PetitionEscrow storage escrow = _escrows[petitionId];\r\n    require(!escrow.initialized, \"ALREADY_INITIALIZED\");\r\n\r\n    uint256 totalMilestones = amounts.length;\r\n    for (uint256 i = 0; i < totalMilestones; i++) {\r\n      require(amounts[i] > 0, \"INVALID_MILESTONE\");\r\n      _milestones[petitionId].push(Milestone({\r\n        amount: amounts[i],\r\n        approved: false,\r\n        paid: false,\r\n        proofCID: \"\",\r\n        submittedAt: 0,\r\n        submissionCount: 0\r\n      }));\r\n    }\r\n\r\n    escrow.creator = creator;\r\n    escrow.deadline = deadline;\r\n    escrow.milestoneCount = totalMilestones;\r\n    escrow.currentMilestone = 0;\r\n    escrow.initialized = true;\r\n  }\r\n\r\n  function fund(uint256 petitionId) external payable {\r\n    PetitionEscrow storage escrow = _escrows[petitionId];\r\n    require(escrow.initialized, \"NOT_INITIALIZED\");\r\n    require(block.timestamp <= escrow.deadline, \"FUNDING_CLOSED\");\r\n    require(msg.value > 0, \"ZERO_AMOUNT\");\r\n\r\n    escrow.totalFunded += msg.value;\r\n    _fundedBy[petitionId][msg.sender] += msg.value;\r\n\r\n    emit Funded(petitionId, msg.sender, msg.value, block.timestamp);\r\n  }\r\n\r\n  function acceptImplementer(uint256 petitionId) external {\r\n    PetitionEscrow storage escrow = _escrows[petitionId];\r\n    require(escrow.initialized, \"NOT_INITIALIZED\");\r\n    require(escrow.implementer == address(0), \"IMPLEMENTER_SET\");\r\n\r\n    string memory profileCID = implementerRegistry.getProfile(msg.sender);\r\n    require(bytes(profileCID).length > 0, \"PROFILE_NOT_SET\");\r\n\r\n    escrow.implementer = msg.sender;\r\n\r\n    emit ImplementerAccepted(petitionId, msg.sender, profileCID, block.timestamp);\r\n  }\r\n\r\n  function submitMilestone(uint256 petitionId, uint256 milestoneIndex, string calldata proofCID) external {\r\n    PetitionEscrow storage escrow = _escrows[petitionId];\r\n    require(escrow.initialized, \"NOT_INITIALIZED\");\r\n    require(escrow.implementer == msg.sender, \"NOT_IMPLEMENTER\");\r\n    require(milestoneIndex == escrow.currentMilestone, \"NOT_CURRENT_MILESTONE\");\r\n    require(milestoneIndex < _milestones[petitionId].length, \"INVALID_MILESTONE\");\r\n    require(bytes(proofCID).length > 0, \"EMPTY_CID\");\r\n\r\n    Vote storage vote = _votes[petitionId][milestoneIndex];\r\n    if (_voteRounds[petitionId][milestoneIndex] > 0) {\r\n      require(vote.finalized, \"VOTE_ACTIVE\");\r\n    }\r\n\r\n    Milestone storage milestone = _milestones[petitionId][milestoneIndex];\r\n    require(!milestone.approved, \"ALREADY_APPROVED\");\r\n    require(milestone.submissionCount < 2, \"MAX_SUBMISSIONS\");\r\n\r\n    milestone.proofCID = proofCID;\r\n    milestone.submittedAt = block.timestamp;\r\n    milestone.submissionCount += 1;\r\n\r\n    uint256 round = _voteRounds[petitionId][milestoneIndex] + 1;\r\n    _voteRounds[petitionId][milestoneIndex] = round;\r\n\r\n    vote.yesVotes = 0;\r\n    vote.noVotes = 0;\r\n    vote.endTime = block.timestamp + votingWindow;\r\n    vote.finalized = false;\r\n\r\n    emit MilestoneSubmitted(petitionId, milestoneIndex, proofCID, block.timestamp);\r\n  }\r\n\r\n  function voteOnMilestone(uint256 petitionId, uint256 milestoneIndex, bool support) external {\r\n    require(_fundedBy[petitionId][msg.sender] > 0, \"NOT_FUNDER\");\r\n\r\n    Vote storage vote = _votes[petitionId][milestoneIndex];\r\n    uint256 round = _voteRounds[petitionId][milestoneIndex];\r\n    require(round > 0, \"NO_SUBMISSION\");\r\n    require(block.timestamp <= vote.endTime, \"VOTING_CLOSED\");\r\n\r\n    require(_lastVotedRound[petitionId][milestoneIndex][msg.sender] < round, \"ALREADY_VOTED\");\r\n    _lastVotedRound[petitionId][milestoneIndex][msg.sender] = round;\r\n\r\n    if (support) {\r\n      vote.yesVotes += 1;\r\n    } else {\r\n      vote.noVotes += 1;\r\n    }\r\n  }\r\n\r\n  function finalizeMilestone(uint256 petitionId, uint256 milestoneIndex) external nonReentrant {\r\n    Vote storage vote = _votes[petitionId][milestoneIndex];\r\n    uint256 round = _voteRounds[petitionId][milestoneIndex];\r\n    require(round > 0, \"NO_SUBMISSION\");\r\n    require(!vote.finalized, \"VOTE_FINALIZED\");\r\n    require(block.timestamp > vote.endTime, \"VOTE_ACTIVE\");\r\n\r\n    vote.finalized = true;\r\n\r\n    if (vote.yesVotes > vote.noVotes) {\r\n      PetitionEscrow storage escrow = _escrows[petitionId];\r\n      Milestone storage milestone = _milestones[petitionId][milestoneIndex];\r\n\r\n      require(!milestone.approved, \"ALREADY_APPROVED\");\r\n      require(escrow.implementer != address(0), \"NO_IMPLEMENTER\");\r\n\r\n      uint256 available = escrow.totalFunded - escrow.totalPaid;\r\n      require(available >= milestone.amount, \"INSUFFICIENT_FUNDS\");\r\n\r\n      milestone.approved = true;\r\n      milestone.paid = true;\r\n      escrow.totalPaid += milestone.amount;\r\n      escrow.currentMilestone += 1;\r\n      _pendingPayouts[escrow.implementer] += milestone.amount;\r\n\r\n      emit MilestoneApproved(petitionId, milestoneIndex, msg.sender, block.timestamp);\r\n      emit PayoutReleased(petitionId, milestoneIndex, milestone.amount, escrow.implementer, block.timestamp);\r\n    }\r\n  }\r\n\r\n  function claimRefund(uint256 petitionId) external nonReentrant {\r\n    PetitionEscrow storage escrow = _escrows[petitionId];\r\n    require(escrow.initialized, \"NOT_INITIALIZED\");\r\n    require(block.timestamp > escrow.deadline, \"DEADLINE_NOT_REACHED\");\r\n    require(escrow.totalPaid == 0, \"PAYOUTS_MADE\");\r\n\r\n    uint256 amount = _fundedBy[petitionId][msg.sender];\r\n    require(amount > 0, \"NOT_FUNDER\");\r\n    _fundedBy[petitionId][msg.sender] = 0;\r\n\r\n    escrow.totalFunded -= amount;\r\n    _safeTransfer(msg.sender, amount);\r\n\r\n    emit RefundsClaimed(petitionId, msg.sender, amount, block.timestamp);\r\n  }\r\n\r\n  function withdrawPayout() external nonReentrant {\r\n    uint256 amount = _pendingPayouts[msg.sender];\r\n    require(amount > 0, \"NO_PAYOUT\");\r\n\r\n    _pendingPayouts[msg.sender] = 0;\r\n    _safeTransfer(msg.sender, amount);\r\n  }\r\n\r\n  function getEscrow(uint256 petitionId)\r\n    external\r\n    view\r\n    returns (\r\n      address creator,\r\n      address implementer,\r\n      uint256 deadline,\r\n      uint256 totalFunded,\r\n      uint256 totalPaid,\r\n      uint256 milestoneCount,\r\n      uint256 currentMilestone,\r\n      bool initialized\r\n    )\r\n  {\r\n    PetitionEscrow storage escrow = _escrows[petitionId];\r\n    return (\r\n      escrow.creator,\r\n      escrow.implementer,\r\n      escrow.deadline,\r\n      escrow.totalFunded,\r\n      escrow.totalPaid,\r\n      escrow.milestoneCount,\r\n      escrow.currentMilestone,\r\n      escrow.initialized\r\n    );\r\n  }\r\n\r\n  function getMilestone(uint256 petitionId, uint256 milestoneIndex)\r\n    external\r\n    view\r\n    returns (\r\n      uint256 amount,\r\n      bool approved,\r\n      bool paid,\r\n      string memory proofCID,\r\n      uint256 submittedAt,\r\n      uint256 submissionCount\r\n    )\r\n  {\r\n    require(milestoneIndex < _milestones[petitionId].length, \"INVALID_MILESTONE\");\r\n    Milestone storage milestone = _milestones[petitionId][milestoneIndex];\r\n\r\n    return (\r\n      milestone.amount,\r\n      milestone.approved,\r\n      milestone.paid,\r\n      milestone.proofCID,\r\n      milestone.submittedAt,\r\n      milestone.submissionCount\r\n    );\r\n  }\r\n\r\n  function getVote(uint256 petitionId, uint256 milestoneIndex)\r\n    external\r\n    view\r\n    returns (uint256 yesVotes, uint256 noVotes, uint256 endTime, bool finalized, uint256 round)\r\n  {\r\n    Vote storage vote = _votes[petitionId][milestoneIndex];\r\n    return (vote.yesVotes, vote.noVotes, vote.endTime, vote.finalized, _voteRounds[petitionId][milestoneIndex]);\r\n  }\r\n\r\n  function fundedAmount(uint256 petitionId, address funder) external view returns (uint256) {\r\n    return _fundedBy[petitionId][funder];\r\n  }\r\n\r\n  function pendingPayout(address implementer) external view returns (uint256) {\r\n    return _pendingPayouts[implementer];\r\n  }\r\n\r\n  function _safeTransfer(address to, uint256 amount) private {\r\n    (bool success, ) = to.call{value: amount}(\"\");\r\n    require(success, \"TRANSFER_FAILED\");\r\n  }\r\n}\r\n"
      }
    }
  }
}